================================================================================
Pipeline Execution Results
Started: 2025-12-14 18:19:18
================================================================================

================================================================================
Running: 01_extract_data.py
Time: 2025-12-14 18:19:18
================================================================================

/Users/vivianj/Library/Python/3.9/lib/python/site-packages/urllib3/__init__.py:35: NotOpenSSLWarning: urllib3 v2 only supports OpenSSL 1.1.1+, currently the 'ssl' module is compiled with 'LibreSSL 2.8.3'. See: https://github.com/urllib3/urllib3/issues/3020
  warnings.warn(
Data collection configuration:
  Number of drugs: 35
  Records per drug: 500
  Expected total volume: ~17,500
  Estimated runtime: 70 minutes

Drug list:
   1. Pembrolizumab
   2. Nivolumab
   3. Atezolizumab
   4. Durvalumab
   5. Ipilimumab
   6. Trastuzumab
   7. Bevacizumab
   8. Cetuximab
   9. Rituximab
  10. Epcoritamab
  11. Pertuzumab
  12. Panitumumab
  13. Ramucirumab
  14. Daratumumab
  15. Imatinib
  16. Erlotinib
  17. Gefitinib
  18. Osimertinib
  19. Crizotinib
  20. Palbociclib
  21. Ribociclib
  22. Abemaciclib
  23. Vemurafenib
  24. Dabrafenib
  25. Ibrutinib
  26. Venetoclax
  27. Olaparib
  28. Rucaparib
  29. Niraparib
  30. Talazoparib
  31. Paclitaxel
  32. Docetaxel
  33. Doxorubicin
  34. Lenalidomide
  35. Pomalidomide


================================================================================
Starting data collection
================================================================================

[1/35] Pembrolizumab
--------------------------------------------------------------------------------

Collecting drug: Pembrolizumab
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
   Total unique reports: 500 | Successful drugs: 1

[2/35] Nivolumab
--------------------------------------------------------------------------------

Collecting drug: Nivolumab
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 499 (-1)
   Total unique reports: 999 | Successful drugs: 2

[3/35] Atezolizumab
--------------------------------------------------------------------------------

Collecting drug: Atezolizumab
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
   Total unique reports: 1499 | Successful drugs: 3

[4/35] Durvalumab
--------------------------------------------------------------------------------

Collecting drug: Durvalumab
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
   Total unique reports: 1999 | Successful drugs: 4

[5/35] Ipilimumab
--------------------------------------------------------------------------------

Collecting drug: Ipilimumab
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 461 (-39)
   Total unique reports: 2460 | Successful drugs: 5

[6/35] Trastuzumab
--------------------------------------------------------------------------------

Collecting drug: Trastuzumab
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
   Total unique reports: 2960 | Successful drugs: 6

[7/35] Bevacizumab
--------------------------------------------------------------------------------

Collecting drug: Bevacizumab
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 496 (-4)
   Total unique reports: 3456 | Successful drugs: 7

[8/35] Cetuximab
--------------------------------------------------------------------------------

Collecting drug: Cetuximab
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 496 (-4)
   Total unique reports: 3952 | Successful drugs: 8

[9/35] Rituximab
--------------------------------------------------------------------------------

Collecting drug: Rituximab
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 494 (-6)
   Total unique reports: 4446 | Successful drugs: 9

[10/35] Epcoritamab
--------------------------------------------------------------------------------

Collecting drug: Epcoritamab
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
   Total unique reports: 4946 | Successful drugs: 10
Checkpoint saved: task5_data_temp_10.csv

[11/35] Pertuzumab
--------------------------------------------------------------------------------

Collecting drug: Pertuzumab
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 398 (-102)
   Total unique reports: 5344 | Successful drugs: 11

[12/35] Panitumumab
--------------------------------------------------------------------------------

Collecting drug: Panitumumab
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 498 (-2)
   Total unique reports: 5842 | Successful drugs: 12

[13/35] Ramucirumab
--------------------------------------------------------------------------------

Collecting drug: Ramucirumab
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
   Total unique reports: 6342 | Successful drugs: 13

[14/35] Daratumumab
--------------------------------------------------------------------------------

Collecting drug: Daratumumab
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
   Total unique reports: 6842 | Successful drugs: 14

[15/35] Imatinib
--------------------------------------------------------------------------------

Collecting drug: Imatinib
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
   Total unique reports: 7342 | Successful drugs: 15

[16/35] Erlotinib
--------------------------------------------------------------------------------

Collecting drug: Erlotinib
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 480 (-20)
   Total unique reports: 7822 | Successful drugs: 16

[17/35] Gefitinib
--------------------------------------------------------------------------------

Collecting drug: Gefitinib
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 496 (-4)
   Total unique reports: 8318 | Successful drugs: 17

[18/35] Osimertinib
--------------------------------------------------------------------------------

Collecting drug: Osimertinib
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 491 (-9)
   Total unique reports: 8809 | Successful drugs: 18

[19/35] Crizotinib
--------------------------------------------------------------------------------

Collecting drug: Crizotinib
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 498 (-2)
   Total unique reports: 9307 | Successful drugs: 19

[20/35] Palbociclib
--------------------------------------------------------------------------------

Collecting drug: Palbociclib
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
   Total unique reports: 9807 | Successful drugs: 20
Checkpoint saved: task5_data_temp_20.csv

[21/35] Ribociclib
--------------------------------------------------------------------------------

Collecting drug: Ribociclib
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
   Total unique reports: 10307 | Successful drugs: 21

[22/35] Abemaciclib
--------------------------------------------------------------------------------

Collecting drug: Abemaciclib
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 499 (-1)
   Total unique reports: 10806 | Successful drugs: 22

[23/35] Vemurafenib
--------------------------------------------------------------------------------

Collecting drug: Vemurafenib
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 490 (-10)
   Total unique reports: 11296 | Successful drugs: 23

[24/35] Dabrafenib
--------------------------------------------------------------------------------

Collecting drug: Dabrafenib
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 459 (-41)
   Total unique reports: 11755 | Successful drugs: 24

[25/35] Ibrutinib
--------------------------------------------------------------------------------

Collecting drug: Ibrutinib
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 489 (-11)
   Total unique reports: 12244 | Successful drugs: 25

[26/35] Venetoclax
--------------------------------------------------------------------------------

Collecting drug: Venetoclax
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
   Total unique reports: 12744 | Successful drugs: 26

[27/35] Olaparib
--------------------------------------------------------------------------------

Collecting drug: Olaparib
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 494 (-6)
   Total unique reports: 13238 | Successful drugs: 27

[28/35] Rucaparib
--------------------------------------------------------------------------------

Collecting drug: Rucaparib
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
   Total unique reports: 13738 | Successful drugs: 28

[29/35] Niraparib
--------------------------------------------------------------------------------

Collecting drug: Niraparib
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
   Total unique reports: 14238 | Successful drugs: 29

[30/35] Talazoparib
--------------------------------------------------------------------------------

Collecting drug: Talazoparib
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
   Total unique reports: 14738 | Successful drugs: 30
Checkpoint saved: task5_data_temp_30.csv

[31/35] Paclitaxel
--------------------------------------------------------------------------------

Collecting drug: Paclitaxel
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 369 (-131)
   Total unique reports: 15107 | Successful drugs: 31

[32/35] Docetaxel
--------------------------------------------------------------------------------

Collecting drug: Docetaxel
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 331 (-169)
   Total unique reports: 15438 | Successful drugs: 32

[33/35] Doxorubicin
--------------------------------------------------------------------------------

Collecting drug: Doxorubicin
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 304 (-196)
   Total unique reports: 15742 | Successful drugs: 33

[34/35] Lenalidomide
--------------------------------------------------------------------------------

Collecting drug: Lenalidomide
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 489 (-11)
   Total unique reports: 16231 | Successful drugs: 34

[35/35] Pomalidomide
--------------------------------------------------------------------------------

Collecting drug: Pomalidomide
   Progress: 100 (new 100 this page)
   Progress: 200 (new 100 this page)
   Progress: 300 (new 100 this page)
   Progress: 400 (new 100 this page)
   Progress: 500 (new 100 this page)
   Completed: 500 records
Global dedup: 500 -> 497 (-3)
   Total unique reports: 16728 | Successful drugs: 35

================================================================================
Data collection finished
================================================================================

Cleaning data...
  Raw records: 16728
  After deduplication: 16728
  Valid records: 16728

================================================================================
Data collection succeeded!
================================================================================

Data summary:
  Total records: 16,728
  Unique reports: 16,728
  Unique drugs: 35
  Successful drugs: 35/35

Severity distribution:
  Death cases: 3,930 (23.5%)
  Hospitalizations: 7,099 (42.4%)
  Life-threatening: 1,352 (8.1%)
  Disability: 797 (4.8%)

Patient demographics:
  Code 2: 8,502 (50.8%)
  Code 1: 6,545 (39.1%)
  Unknown: 1,140 (6.8%)
  Code 0: 541 (3.2%)
  Mean age: 1084.6 years
  Age range: 0.0 - 34936.0 years

Reports per drug:
  Pembrolizumab       :   500
  Venetoclax          :   500
  Palbociclib         :   500
  Ribociclib          :   500
  Imatinib            :   500
  Daratumumab         :   500
  Ramucirumab         :   500
  Epcoritamab         :   500
  Rucaparib           :   500
  Niraparib           :   500
  ... (plus 25 additional drugs)

Elapsed time: 5.1 minutes
Output file: main_data.csv

Saved summary: task5_collection_summary.txt

================================================================================
Data sample (first 5 rows)
================================================================================

     target_drug  seriousnessdeath  ...  num_drugs num_reactions
0  Pembrolizumab                 1  ...         28             1
1  Pembrolizumab                 0  ...          4             7
2  Pembrolizumab                 0  ...         18             2
3  Pembrolizumab                 0  ...         16             2
4  Pembrolizumab                 0  ...          7             1

[5 rows x 7 columns]

================================================================================
Next steps
================================================================================

Data is ready for downstream steps:
  1. Run: python 02_inspect_data.py
  2. Or inspect manually: open main_data.csv

Tip: Later steps automatically read this file



================================================================================
Running: 02_inspect_data.py
Time: 2025-12-14 18:24:22
================================================================================

Data source: main_data.csv
   (Task 5 dataset - 35 oncology drugs)

Loading data...
Data loaded successfully

================================================================================
Dataset overview
================================================================================

Rows: 16728
Columns: 22

Columns:
   1. safetyreportid
   2. receivedate
   3. target_drug
   4. patientonsetage
   5. patientonsetageunit
   6. age_years
   7. patientsex
   8. patientweight
   9. serious
  10. seriousnessdeath
  11. seriousnesshospitalization
  12. seriousnesslifethreatening
  13. seriousnessdisabling
  14. seriousnesscongenitalanomali
  15. seriousnessother
  16. drugname
  17. all_drugs
  18. num_drugs
  19. drug_indication
  20. reactions
  21. num_reactions
  22. reporter_qualification

================================================================================
Data quality checks
================================================================================

Duplicate report check:
  Duplicates: 0 (0.00%)
  No duplicate reports

Missing value summary:
                Column  Missing  Missing %
         patientweight    11105  66.385701
   patientonsetageunit     4997  29.872071
             age_years     4997  29.872071
       patientonsetage     4996  29.866093
       drug_indication     1224   7.317073
             all_drugs      756   4.519369
reporter_qualification      618   3.694405

================================================================================
Drug distribution
================================================================================

Using column: target_drug
Distinct drugs: 35

Top 10 drugs:
  Pembrolizumab       :   500 (  3.0%)
  Venetoclax          :   500 (  3.0%)
  Palbociclib         :   500 (  3.0%)
  Ribociclib          :   500 (  3.0%)
  Imatinib            :   500 (  3.0%)
  Daratumumab         :   500 (  3.0%)
  Ramucirumab         :   500 (  3.0%)
  Epcoritamab         :   500 (  3.0%)
  Rucaparib           :   500 (  3.0%)
  Niraparib           :   500 (  3.0%)

================================================================================
Report date audit
================================================================================

Date range: 2012-07-09 to 2022-11-08
Span: 3774 days (10.3  years)
Valid dates: 16728 / 16728 (100.0%)

Annual distribution:
  2012:     4 reports
  2013:     1 reports
  2014:  9098 reports
  2015:  2147 reports
  2016:  2146 reports
  2017:  1907 reports
  2018:   483 reports
  2019:   210 reports
  2020:   207 reports
  2021:   195 reports

================================================================================
Severity analysis
================================================================================

Serious events: 16728 cases (100.0%)
Death       : 3930 cases ( 23.5%)
Hospitalization: 7099 cases ( 42.4%)
Life-threatening: 1352 cases (  8.1%)
Disability  :  797 cases (  4.8%)
Congenital anomaly:  500 cases (  3.0%)
Other serious: 6512 cases ( 38.9%)

Severity consistency check:
  Inconsistent records: 3107 (18.57%)
  Note: 'serious' flag does not fully match sub-flags

================================================================================
Patient demographics
================================================================================

Sex distribution:
  Female: 8502 (50.8%)
  Male: 6545 (39.1%)
  Unknown: 1681 (10.0%)

Age statistics:
  Count: 11732
  Mean age: 1084.6
  Median: 65.0
  Min: 0.0
  Max: 34936.0

Drug usage stats:
  Average drugs: 7.1
  Max drugs: 345
  Polypharmacy (>1 drug): 11168 (66.8%)

================================================================================
Data sample
================================================================================

   safetyreportid  receivedate  ... receivedate_parsed  year
0        10222779     20140606  ...         2014-06-06  2014
1        10329607     20140721  ...         2014-07-21  2014
2        10329852     20140721  ...         2014-07-21  2014
3        10329858     20140721  ...         2014-07-21  2014
4        10329882     20140721  ...         2014-07-21  2014

[5 rows x 24 columns]

================================================================================
Epcoritamab + CRS Analysis
================================================================================

Epcoritamab Reports:
   Total Epcoritamab reports: 500

Death Outcomes:
   Deaths in Epcoritamab reports: 435 (87.0%)

CRS (Cytokine Release Syndrome):
   Epcoritamab reports with CRS: 185 (37.0%)

CRS -> Death:
   Deaths in CRS patients: 150 / 185 (81.1%)

================================================================================
Summary for Report/Slides:
================================================================================

In our dataset, we have 500 Epcoritamab reports.
Among these, 185 reports (37.0%) contain CRS-related adverse events.
Of the 185 CRS cases, 150 resulted in death (81.1%).

Key Statistics:
   â€¢ Total Epcoritamab reports: 500
   â€¢ Reports with CRS: 185 (37.0%)
   â€¢ Total deaths in Epcoritamab reports: 435 (87.0%)
   â€¢ Deaths in CRS patients: 150 / 185 (81.1%)

================================================================================
Step 2 complete - data inspection finished
================================================================================

Data quality assessment:
    Excellent: strong sample size for modelling

Next steps:
  Run: python 03_preprocess_data.py
  Purpose: data preprocessing and feature engineering



================================================================================
Running: 03_preprocess_data.py
Time: 2025-12-14 18:24:22
================================================================================

/Users/vivianj/Desktop/Task5/task5_severity_prediction/03_preprocess_data.py:298: UserWarning: This pattern is interpreted as a regular expression, and has match groups. To actually get the groups, use str.extract.
  df['cancer_stage_I'] = indication_upper.str.contains(stage_i_pattern, regex=True, na=False).astype(int)
/Users/vivianj/Desktop/Task5/task5_severity_prediction/03_preprocess_data.py:302: UserWarning: This pattern is interpreted as a regular expression, and has match groups. To actually get the groups, use str.extract.
  df['cancer_stage_II'] = indication_upper.str.contains(stage_ii_pattern, regex=True, na=False).astype(int)
/Users/vivianj/Desktop/Task5/task5_severity_prediction/03_preprocess_data.py:305: UserWarning: This pattern is interpreted as a regular expression, and has match groups. To actually get the groups, use str.extract.
  indication_upper.str.contains(r'STAGE\s+2(\s|$|,|\|)', regex=True, na=False)).astype(int)
/Users/vivianj/Desktop/Task5/task5_severity_prediction/03_preprocess_data.py:309: UserWarning: This pattern is interpreted as a regular expression, and has match groups. To actually get the groups, use str.extract.
  df['cancer_stage_III'] = indication_upper.str.contains(stage_iii_pattern, regex=True, na=False).astype(int)
/Users/vivianj/Desktop/Task5/task5_severity_prediction/03_preprocess_data.py:312: UserWarning: This pattern is interpreted as a regular expression, and has match groups. To actually get the groups, use str.extract.
  indication_upper.str.contains(r'STAGE\s+3(\s|$|,|\|)', regex=True, na=False)).astype(int)
/Users/vivianj/Desktop/Task5/task5_severity_prediction/03_preprocess_data.py:316: UserWarning: This pattern is interpreted as a regular expression, and has match groups. To actually get the groups, use str.extract.
  df['cancer_stage_IV'] = indication_upper.str.contains(stage_iv_pattern, regex=True, na=False).astype(int)
/Users/vivianj/Desktop/Task5/task5_severity_prediction/03_preprocess_data.py:319: UserWarning: This pattern is interpreted as a regular expression, and has match groups. To actually get the groups, use str.extract.
  indication_upper.str.contains(r'STAGE\s+4(\s|$|,|\|)', regex=True, na=False)).astype(int)
âœ… Input file: main_data.csv
   (Task 5 dataset - 35 oncology drugs)

âœ… Input file: main_data.csv

ğŸ“‚ Loading source data...
âœ… Raw data: 16728 rows, 22 columns

âœ… Deduplication check: no duplicates found

================================================================================
ğŸ”„ Running preprocessing pipeline
================================================================================

Processing steps:
  1ï¸âƒ£  Convert numeric fields
  2ï¸âƒ£  Feature engineering (create new features)
  3ï¸âƒ£  Handle missing values
  4ï¸âƒ£  Clean data

1ï¸âƒ£  Converting numeric fields...
âœ… Numeric conversion complete

2ï¸âƒ£  Feature engineering...
ğŸ”¹ Weight normalization and BMI calculation...
   BMI calculated for 16728 patients
   Underweight: 556, Normal: 1872
   Overweight: 12600, Obese: 1700
ğŸ”¹ Extracting drug class features...
   Steroid: 2497, Antibiotic: 634
   Antiviral: 758, Chemo: 2301
   Steroid+Antibiotic combo: 368
ğŸ”¹ Extracting cancer stage from free-text drug_indication (imperfect extraction)...
   Stage I: 18 patients
   Stage II: 33 patients
   Stage III: 120 patients
   Stage IV: 19 patients
ğŸ”¹ Handling missing values...
   Filled patientonsetage missing values with median: 64.00
   Filled patientonsetageunit missing values with median: 801.00
   Filled age_years missing values with median: 64.00
   Filled reporter_qualification missing values with median: 3.00
âœ… Feature engineering complete
   New features added: 41

ğŸ’¾ Saving preprocessed data...
âœ… Saved: ./preprocessed_data.csv

ğŸ†• New feature list:
   1. age_group
   2. age_0-18
   3. age_19-45
   4. age_46-65
   5. age_66+
   6. age_missing
   7. sex_male
   8. sex_female
   9. sex_unknown
  10. age_gt_65
  11. age_gt_70
  12. age_gt_75
  13. weight_missing
  14. bmi
  15. bmi_underweight
  16. bmi_normal
  17. bmi_overweight
  18. bmi_obese
  19. polypharmacy
  20. high_polypharmacy
  21. moderate_polypharmacy
  22. very_high_polypharmacy
  23. polypharmacy_class
  24. polypharmacy_high
  25. polypharmacy_low
  26. polypharmacy_moderate
  27. polypharmacy_very_high
  28. has_steroid
  29. has_antibiotic
  30. has_antiviral
  31. has_chemo
  32. has_targeted
  33. has_antifungal
  34. steroid_plus_antibiotic
  35. multiple_reactions
  36. many_reactions
  37. cancer_stage
  38. cancer_stage_I
  39. cancer_stage_II
  40. cancer_stage_III
  41. cancer_stage_IV

ğŸ¯ Preparing training data
Target variable: seriousnessdeath (death indicator)
Target distribution:
  Positive (death): 3930 (23.5%)
  Negative (survival): 12798 (76.5%)
ğŸ” Selecting features...
âœ… Leakage check passed: no severity-related columns present
âœ… Selected 36 features
Feature columns:
   1. patientonsetage
   2. age_years
   3. patientsex
   4. patientweight
   5. num_drugs
   6. num_reactions
   7. age_missing
   8. sex_male
   9. sex_female
  10. sex_unknown
  11. age_gt_65
  12. age_gt_70
  13. age_gt_75
  14. weight_missing
  15. bmi
  16. bmi_underweight
  17. bmi_normal
  18. bmi_overweight
  19. bmi_obese
  20. polypharmacy
  21. high_polypharmacy
  22. moderate_polypharmacy
  23. very_high_polypharmacy
  24. has_steroid
  25. has_antibiotic
  26. has_antiviral
  27. has_chemo
  28. has_targeted
  29. has_antifungal
  30. steroid_plus_antibiotic
  31. multiple_reactions
  32. many_reactions
  33. cancer_stage_I
  34. cancer_stage_II
  35. cancer_stage_III
  36. cancer_stage_IV

ğŸ”§ Handling missing values...
   Missing value summary:
     None
âœ… Missing value handling complete

ğŸ“Š Splitting train and test sets...
Using stratified split (stratify=y)
Train set: 13382 samples
Test set: 3346 samples
âœ… ID leakage check passed: no shared IDs
Train target distribution:
  Positive: 3145 (23.5%)
  Negative: 10237 (76.5%)
Test target distribution:
  Positive: 785 (23.5%)
  Negative: 2561 (76.5%)
ğŸ’¾ Saving train and test datasets...
âœ… Saved:
  - ./X_train.csv
  - ./y_train.csv
  - ./X_test.csv
  - ./y_test.csv
  - preprocess_meta.json

================================================================================
ğŸ“‹ Sample of preprocessed data
================================================================================

     target_drug  seriousnessdeath  ...  num_drugs  num_reactions
0  Pembrolizumab                 1  ...         28              1
1  Pembrolizumab                 0  ...          4              7
2  Pembrolizumab                 0  ...         18              2

[3 rows x 6 columns]

================================================================================
âœ… Step 3 complete - preprocessing finished
================================================================================

ğŸ“ Generated files:
  1. ./preprocessed_data.csv - preprocessed dataset
  2. ./X_train.csv - training features
  3. ./y_train.csv - training labels
  4. ./X_test.csv - test features
  5. ./y_test.csv - test labels

ğŸ¯ Next steps:
  Run: python 04_train_models.py
  Purpose: train multiple machine learning models



================================================================================
Running: 04_train_models.py
Time: 2025-12-14 18:24:32
================================================================================

================================================================================
Task 5 - Step 4/9: Model Training (enhanced)
================================================================================

âœ… Found all required files

ğŸ“‚ Loading training and test data...
Train set (full): 13382 samples, 36 features
Test set: 3346 samples

Validation split: train 10705, validation 2677(Stratified, 20%)

ğŸ“Š Class distribution (full training set)
   Negative (0): 10237 (76.5%)
   Positive (1): 3145 (23.5%)
   Imbalance ratio: 3.26:1

ğŸ”§ Initializing models...
âœ… XGBoost available

Training 4 models:
  1. Logistic Regression
  2. Random Forest
  3. Gradient Boosting
  4. XGBoost

================================================================================
[1/4] Training Logistic Regression
================================================================================
   Validation best threshold (max F1): 0.512 | F1=0.417  (P=0.338, R=0.544)
   Test set: PR-AUC=0.3701 | ROC-AUC=0.6320 | Acc=0.6300 | P=0.3198 | R=0.5121 | F1=0.3937
   Confusion matrix @0.512:
      [[TN=1706  FP= 855]
       [FN= 383  TP= 402]]
================================================================================
[2/4] Training Random Forest
================================================================================
   Validation best threshold (max F1): 0.322 | F1=0.425  (P=0.333, R=0.588)
   Test set: PR-AUC=0.3980 | ROC-AUC=0.6388 | Acc=0.6154 | P=0.3107 | R=0.5248 | F1=0.3903
   Confusion matrix @0.322:
      [[TN=1647  FP= 914]
       [FN= 373  TP= 412]]
================================================================================
[3/4] Training Gradient Boosting
================================================================================
   Validation best threshold (max F1): 0.216 | F1=0.431  (P=0.331, R=0.620)
   Test set: PR-AUC=0.4146 | ROC-AUC=0.6645 | Acc=0.6231 | P=0.3352 | R=0.6166 | F1=0.4343
   Confusion matrix @0.216:
      [[TN=1601  FP= 960]
       [FN= 301  TP= 484]]
================================================================================
[4/4] Training XGBoost
================================================================================
   Validation best threshold (max F1): 0.548 | F1=0.444  (P=0.409, R=0.486)
   Test set: PR-AUC=0.4119 | ROC-AUC=0.6488 | Acc=0.7116 | P=0.3923 | R=0.4178 | F1=0.4047
   Confusion matrix @0.548:
      [[TN=2053  FP= 508]
       [FN= 457  TP= 328]]

âœ… Model training and evaluation complete

================================================================================
ğŸ“Š Model performance comparison (sorted by PR-AUC)
================================================================================
                     accuracy  precision  recall      f1  roc_auc  pr_auc  best_threshold
Gradient Boosting      0.6231     0.3352  0.6166  0.4343   0.6645  0.4146          0.2159
XGBoost                0.7116     0.3923  0.4178  0.4047   0.6488  0.4119          0.5477
Random Forest          0.6154     0.3107  0.5248  0.3903   0.6388  0.3980          0.3222
Logistic Regression    0.6300     0.3198  0.5121  0.3937   0.6320  0.3701          0.5124

ğŸ† Best model: Gradient Boosting  (PR-AUC=0.4146)
   Acc=0.6231, F1=0.4343, ROC-AUC=0.6645, Best threshold=0.216

ğŸ’¾ Saved: ./model_comparison.csv

Calibrating Gradient Boosting probabilities (isotonic, cv=3)...
âœ… Saved: ./trained_model_calibrated.pkl (calibrated)

ğŸ’¾ Saved: ./training_meta.json

================================================================================
ğŸ“Š Feature Importance Analysis (Complete List)
================================================================================

ğŸ“‹ Complete Feature Importance List (36 features):
--------------------------------------------------------------------------------
  1. num_drugs                                : 0.116320
  2. age_years                                : 0.093184
  3. patientweight                            : 0.083871
  4. has_antiviral                            : 0.082858
  5. has_chemo                                : 0.068410
  6. num_reactions                            : 0.066628
  7. bmi                                      : 0.064328
  8. has_targeted                             : 0.064028
  9. patientonsetage                          : 0.048787
 10. patientsex                               : 0.045266
 11. age_missing                              : 0.042658
 12. sex_unknown                              : 0.036868
 13. sex_male                                 : 0.035786
 14. weight_missing                           : 0.029849
 15. sex_female                               : 0.027359
 16. multiple_reactions                       : 0.021147
 17. has_antifungal                           : 0.013334
 18. cancer_stage_III                         : 0.012450
 19. polypharmacy                             : 0.012233
 20. has_antibiotic                           : 0.005733
 21. has_steroid                              : 0.005345
 22. cancer_stage_II                          : 0.004590
 23. many_reactions                           : 0.004132
 24. very_high_polypharmacy                   : 0.003228
 25. bmi_overweight                           : 0.002178
 26. bmi_normal                               : 0.001765
 27. moderate_polypharmacy                    : 0.001365
 28. high_polypharmacy                        : 0.001177
 29. steroid_plus_antibiotic                  : 0.001042
 30. age_gt_75                                : 0.000973
 31. cancer_stage_IV                          : 0.000711
 32. bmi_underweight                          : 0.000659
 33. age_gt_70                                : 0.000641
 34. age_gt_65                                : 0.000580
 35. bmi_obese                                : 0.000422
 36. cancer_stage_I                           : 0.000094

ğŸ’¾ Saved: ./feature_importance_complete.csv (36 features)

âœ… Cancer stage features found: cancer_stage_I, cancer_stage_II, cancer_stage_III, cancer_stage_IV
   cancer_stage_I: importance = 0.000094
   cancer_stage_II: importance = 0.004590
   cancer_stage_III: importance = 0.012450
   cancer_stage_IV: importance = 0.000711

================================================================================
ğŸ” Generating SHAP Values for Interpretability
================================================================================
ğŸ’¾ Saved: ./shap_values_complete.csv (shape: (3346, 36))
ğŸ’¾ Saved: ./shap_feature_importance.csv

================================================================================
âœ… Step 4 complete - model training finished (enhanced)
================================================================================


âœ… Training complete. Best model: Gradient Boosting


================================================================================
Running: 05_analyze_features.py
Time: 2025-12-14 18:24:48
================================================================================

================================================================================
Task 5 - Step 5/9: Feature Importance Analysis (enhanced)
================================================================================

Number of features: 36

ğŸ” Selecting model for analysis
  Best model (by PR-AUC): Gradient Boosting
  Supporting file: trained_model_gradient_boosting.pkl

ğŸ“‚ Loading model...
âœ… Model loaded successfully

================================================================================
ğŸ“Š Feature importance analysis
================================================================================

âœ… Using built-in feature_importances_

Top 20 most important features:

           feature  importance
         num_drugs    0.116320
         age_years    0.093184
     patientweight    0.083871
     has_antiviral    0.082858
         has_chemo    0.068410
     num_reactions    0.066628
               bmi    0.064328
      has_targeted    0.064028
   patientonsetage    0.048787
        patientsex    0.045266
       age_missing    0.042658
       sex_unknown    0.036868
          sex_male    0.035786
    weight_missing    0.029849
        sex_female    0.027359
multiple_reactions    0.021147
    has_antifungal    0.013334
  cancer_stage_III    0.012450
      polypharmacy    0.012233
    has_antibiotic    0.005733

ğŸ’¾ Saved: feature_importance.csv

âœ… Saved: feature_importance.png

================================================================================
ğŸ’¡ Top-5 feature interpretation (heuristic)
================================================================================

1. num_drugs
   Importance: 0.1163
   Note: Medication/comorbidity features - polypharmacy and specific classes may drive severity

2. age_years
   Importance: 0.0932
   Note: Patient age features - risk typically increases with age

3. patientweight
   Importance: 0.0839
   Note: Weight/exposure features - dose-weight balance or metabolism can influence risk

4. has_antiviral
   Importance: 0.0829

5. has_chemo
   Importance: 0.0684

================================================================================
âœ… Step 5 complete - feature analysis finished (enhanced)
================================================================================



================================================================================
Running: 06_visualize_results.py
Time: 2025-12-14 18:24:50
================================================================================

================================================================================
Task 5 - Step 6/9: Results Visualisation (enhanced)
================================================================================

âœ… Found all required files

================================================================================
ğŸ“Š 1. Model comparison
================================================================================

âœ… Saved: model_performance_comparison.png

================================================================================
ğŸ“Š 2. Feature importance
================================================================================

âœ… Saved: top_features.png

================================================================================
ğŸ“Š 3. Data distribution analysis
================================================================================

âœ… Saved: data_distribution.png

================================================================================
ğŸ“ Generating summary report
================================================================================

âœ… Saved: RESULTS_SUMMARY.txt

================================================================================
âœ… Step 6 complete - visualisation finished
================================================================================

ğŸ“ Generated visual assets:
  1. model_performance_comparison.png - model performance comparison
  2. top_features.png - top feature bar chart
  3. data_distribution.png - data distribution summary
  4. RESULTS_SUMMARY.txt - textual summary

ğŸ’¡ View outputs:
  View image: open model_performance_comparison.png
  View report: open RESULTS_SUMMARY.txt

================================================================================
ğŸ‰ Task 5 pipeline complete!
================================================================================

ğŸ“‹ Complete output checklist:

Data files:
  âœ“ preprocessed_data.csv (if present) - preprocessed data
  âœ“ X_train.csv, y_train.csv - training set
  âœ“ X_test.csv, y_test.csv - test set

Model files:
  âœ“ trained_model_logistic_regression.pkl
  âœ“ trained_model_calibrated.pkl
  âœ“ trained_model_gradient_boosting.pkl
  âœ“ trained_model_xgboost.pkl
  âœ“ trained_model_random_forest.pkl

Result files:
  âœ“ model_comparison.csv - model scores
  âœ“ feature_importance.csv - Feature importance table

Visual files:
  âœ“ model_performance_comparison.png
  âœ“ top_features.png
  âœ“ data_distribution.png

Report files:
  âœ“ RESULTS_SUMMARY.txt

ğŸ¯ Suggested next steps:
  1. Review RESULTS_SUMMARY.txt for overall summary
  2. Inspect charts to understand model performance and distributions
  3. Use feature importance to refine modelling
  4. Prepare project report and presentation

================================================================================
ğŸ“ˆ Advanced evaluation curves (PR/ROC/calibration)
================================================================================

âœ… Saved: advanced_evaluation_curves.png
   Using best model: Gradient Boosting
   PR-AUC=0.415, ROC-AUC=0.664, F1Best threshold=0.227




================================================================================
Running: 07_explainability.py
Time: 2025-12-14 18:24:52
================================================================================

================================================================================
Task 5 - Step 7/9: Explainability Analysis (enhanced)
================================================================================

ğŸ” Input files ready
  âœ“ X_train.csv
  âœ“ X_test.csv
  âœ“ y_test.csv
  âœ“ model_comparison.csv

ğŸ† Best model (PR-AUC): Gradient Boosting
   Model file: trained_model_gradient_boosting.pkl
   PR-AUC  : 0.4146
   Threshold (F1@val): 0.216

ğŸ“‚ Loading data and model...
âœ… Data and model loaded successfully

âœ… SHAP installed
âš ï¸  LIME not installed. Install via: pip install lime

ğŸ“Œ SHAP analysis will use 500 test samples (random sample, seed=42)

================================================================================
ğŸ“Š SHAP explainability analysis
================================================================================

âœ… Saved: shap_summary_plot.png
âœ… Saved: shap_bar_plot.png
âœ… Saved: shap_waterfall_death.png
âœ… Saved: shap_waterfall_survival.png
âœ… Saved: shap_values.csv
âœ… Saved: shap_feature_importance.csv

âœ… SHAP analysis complete

================================================================================
ğŸ“ Saving explainability metadata explain_meta.json
================================================================================

âœ… Saved: explain_meta.json

================================================================================
âœ… Step 7 complete - explainability finished (enhanced)
================================================================================

ğŸ“ Generated files:
  SHAP:
   - shap_summary_plot.png
   - shap_bar_plot.png
   - shap_waterfall_death.png
   - shap_waterfall_survival.png
   - shap_values.csv
   - shap_feature_importance.csv

  Metadata:
   - explain_meta.json

ğŸ¯ Key takeaways:
  - Best model automatically aligned with Step 4/6 PR-AUC ranking
  - SHAP provides global and local views; handles different return shapes
  - LIME falls back to decision_function when predict_proba missing
  - All artefacts saved for audit and reproducibility



================================================================================
Running: 08_test_models.py
Time: 2025-12-14 18:24:54
================================================================================

/Users/vivianj/Library/Python/3.9/lib/python/site-packages/sklearn/utils/extmath.py:203: RuntimeWarning: divide by zero encountered in matmul
  ret = a @ b
/Users/vivianj/Library/Python/3.9/lib/python/site-packages/sklearn/utils/extmath.py:203: RuntimeWarning: overflow encountered in matmul
  ret = a @ b
/Users/vivianj/Library/Python/3.9/lib/python/site-packages/sklearn/utils/extmath.py:203: RuntimeWarning: invalid value encountered in matmul
  ret = a @ b
/Users/vivianj/Library/Python/3.9/lib/python/site-packages/sklearn/utils/extmath.py:203: RuntimeWarning: divide by zero encountered in matmul
  ret = a @ b
/Users/vivianj/Library/Python/3.9/lib/python/site-packages/sklearn/utils/extmath.py:203: RuntimeWarning: overflow encountered in matmul
  ret = a @ b
/Users/vivianj/Library/Python/3.9/lib/python/site-packages/sklearn/utils/extmath.py:203: RuntimeWarning: invalid value encountered in matmul
  ret = a @ b
================================================================================
Task 5 - Hold-out Test Evaluation
================================================================================

ğŸ“‚ Loading test data
--------------------------------------------------------------------------------
âœ… Test set: 3346 samples, 36 features

Target distribution:
  Death: 785 (23.5%)
  Survival: 2561 (76.5%)

================================================================================
ğŸ¤– Model evaluation
================================================================================

ğŸ“Š Gradient Boosting
--------------------------------------------------------------------------------
  Accuracy: 0.7747
   Precision: 0.6000
  Recall: 0.1185
  F1 score: 0.1979
  ROC-AUC:  0.6645

  Confusion matrix:
                Predicted survival  Predicted death
  Actual survival   2499        62
  Actual death       692        93

  Specificity (true negative rate): 0.9758
  Negative predictive value: 0.7831

ğŸ“Š XGBoost
--------------------------------------------------------------------------------
  Accuracy: 0.6832
   Precision: 0.3684
  Recall: 0.4904
  F1 score: 0.4208
  ROC-AUC:  0.6488

  Confusion matrix:
                Predicted survival  Predicted death
  Actual survival   1901       660
  Actual death       400       385

  Specificity (true negative rate): 0.7423
  Negative predictive value: 0.8262

ğŸ“Š Random Forest
--------------------------------------------------------------------------------
  Accuracy: 0.7490
   Precision: 0.4513
  Recall: 0.3248
  F1 score: 0.3778
  ROC-AUC:  0.6388

  Confusion matrix:
                Predicted survival  Predicted death
  Actual survival   2251       310
  Actual death       530       255

  Specificity (true negative rate): 0.8790
  Negative predictive value: 0.8094

ğŸ“Š Logistic Regression
--------------------------------------------------------------------------------
  Accuracy: 0.6246
   Precision: 0.3272
  Recall: 0.5682
  F1 score: 0.4153
  ROC-AUC:  0.6320

  Confusion matrix:
                Predicted survival  Predicted death
  Actual survival   1644       917
  Actual death       339       446

  Specificity (true negative rate): 0.6419
  Negative predictive value: 0.8290

================================================================================
ğŸ“Š Test results summary
================================================================================

                     accuracy  precision  recall      f1  roc_auc
XGBoost                0.6832     0.3684  0.4904  0.4208   0.6488
Logistic Regression    0.6246     0.3272  0.5682  0.4153   0.6320
Random Forest          0.7490     0.4513  0.3248  0.3778   0.6388
Gradient Boosting      0.7747     0.6000  0.1185  0.1979   0.6645

ğŸ† Best model: XGBoost
   F1 score: 0.4208
   ROC-AUC: 0.6488

ğŸ’¾ Saved: test_set_results.csv

================================================================================
ğŸ“Š Per-drug analysis (Top 10)
================================================================================

Model used: XGBoost

Top 10 drugs (by sample size):

Pembrolizumab       : 500 samples, accuracy 0.648, death rate 0.230
Atezolizumab        : 500 samples, accuracy 0.670, death rate 0.264
Durvalumab          : 500 samples, accuracy 0.728, death rate 0.226
Trastuzumab         : 500 samples, accuracy 0.714, death rate 0.226
Nivolumab           : 499 samples, accuracy 0.677, death rate 0.242
Ipilimumab          : 461 samples, accuracy 0.649, death rate 0.221
Bevacizumab         : 386 samples, accuracy 0.697, death rate 0.231

ğŸ’¾ Saved: test_by_drug.csv

================================================================================
âœ… Test complete
================================================================================

ğŸ¯ Key findings:
  1. Test sample size: 3346
  2. Test set mortality: 23.5%
  3. Best F1 score: 0.4208
  4. Best ROC-AUC: 0.6488

ğŸ’¡ Notes:
  - This is performance on an independent test set
  - Test set spans multiple drugs for generalisation insight
  - F1 balances precision and recall



================================================================================
Running: 09_test_epcoritamab.py
Time: 2025-12-14 18:24:55
================================================================================

/Users/vivianj/Library/Python/3.9/lib/python/site-packages/sklearn/utils/extmath.py:203: RuntimeWarning: divide by zero encountered in matmul
  ret = a @ b
/Users/vivianj/Library/Python/3.9/lib/python/site-packages/sklearn/utils/extmath.py:203: RuntimeWarning: overflow encountered in matmul
  ret = a @ b
/Users/vivianj/Library/Python/3.9/lib/python/site-packages/sklearn/utils/extmath.py:203: RuntimeWarning: invalid value encountered in matmul
  ret = a @ b
/Users/vivianj/Library/Python/3.9/lib/python/site-packages/sklearn/utils/extmath.py:203: RuntimeWarning: divide by zero encountered in matmul
  ret = a @ b
/Users/vivianj/Library/Python/3.9/lib/python/site-packages/sklearn/utils/extmath.py:203: RuntimeWarning: overflow encountered in matmul
  ret = a @ b
/Users/vivianj/Library/Python/3.9/lib/python/site-packages/sklearn/utils/extmath.py:203: RuntimeWarning: invalid value encountered in matmul
  ret = a @ b
================================================================================
Task 5 - Epcoritamab Focused Evaluation
================================================================================

ğŸ“‚ Step 1: Extract Epcoritamab test data
--------------------------------------------------------------------------------
âœ… Loaded raw data: 16728 records
âœ… Extracted Epcoritamab data: 500 records

ğŸ“Š Epcoritamab data overview:
  Total records: 500
  Death cases: 435 (87.0%)
  Hospitalisation cases: 500 (100.0%)
  Life-threatening cases: 454 (90.8%)

ğŸ”§ Step 2: Preprocess Epcoritamab data
--------------------------------------------------------------------------------
âœ… Feature engineering complete

ğŸ¯ Step 3: Prepare test features
--------------------------------------------------------------------------------
Test samples: 500
Feature count: 36

Target distribution:
  Death: 435 (87.0%)
  Survival: 65 (13.0%)

âœ… Data preprocessing complete

================================================================================
ğŸ¤– Step 4: Model evaluation
================================================================================

ğŸ“Š Testing model: Gradient Boosting
--------------------------------------------------------------------------------
  Accuracy: 0.8580
  Precision: 0.8776
  Recall: 0.9724
  F1 score: 0.9226
  ROC-AUC:  0.6069

  Confusion matrix:
                Predicted survival  Predicted death
  Actual survival      6        59
  Actual death        12       423

ğŸ“Š Testing model: XGBoost
--------------------------------------------------------------------------------
  Accuracy: 0.5300
  Precision: 0.9464
  Recall: 0.4874
  F1 score: 0.6434
  ROC-AUC:  0.7132

  Confusion matrix:
                Predicted survival  Predicted death
  Actual survival     53        12
  Actual death       223       212

ğŸ“Š Testing model: Random Forest
--------------------------------------------------------------------------------
  Accuracy: 0.1300
  Precision: 0.0000
  Recall: 0.0000
  F1 score: 0.0000
  ROC-AUC:  0.6841

  Confusion matrix:
                Predicted survival  Predicted death
  Actual survival     65         0
  Actual death       435         0

ğŸ“Š Testing model: Logistic Regression
--------------------------------------------------------------------------------
  Accuracy: 0.1780
  Precision: 0.9615
  Recall: 0.0575
  F1 score: 0.1085
  ROC-AUC:  0.6849

  Confusion matrix:
                Predicted survival  Predicted death
  Actual survival     64         1
  Actual death       410        25

================================================================================
ğŸ“Š Epcoritamab test summary
================================================================================

                    accuracy precision    recall        f1   roc_auc
Gradient Boosting      0.858  0.877593  0.972414  0.922574  0.606861
XGBoost                 0.53  0.946429  0.487356  0.643399  0.713227
Logistic Regression    0.178  0.961538  0.057471   0.10846  0.684934
Random Forest           0.13       0.0       0.0       0.0   0.68412

ğŸ† Best model on Epcoritamab: Gradient Boosting
    Accuracy: 0.8580
   F1 score: 0.9226
   ROC-AUC: 0.6069

ğŸ’¾ Saved: epcoritamab_test_results.csv

================================================================================
ğŸ“Š Performance comparison: overall vs Epcoritamab
================================================================================

Comparison notes:
  - Overall: trained/tested on all 35 drugs
  - Epcoritamab: evaluated only on target drug records

Gradient Boosting:
  Accuracy (overall) 0.6231 | Epcoritamab 0.8580
  F1 score (overall) 0.4343 | Epcoritamab 0.9226

XGBoost:
  Accuracy (overall) 0.7116 | Epcoritamab 0.5300
  F1 score (overall) 0.4047 | Epcoritamab 0.6434

Random Forest:
  Accuracy (overall) 0.6154 | Epcoritamab 0.1300
  F1 score (overall) 0.3903 | Epcoritamab 0.0000

Logistic Regression:
  Accuracy (overall) 0.6300 | Epcoritamab 0.1780
  F1 score (overall) 0.3937 | Epcoritamab 0.1085

================================================================================
âœ… Epcoritamab evaluation complete
================================================================================

ğŸ¯ Key findings:
 1. Epcoritamab test samples: 500
 2. Mortality rate: 87.0%
 3. Best model performance: 0.9226 (F1 score)
ğŸ’¡ Notes:
  - This represents model behaviour on the target drug cohort
  - Consider complementing with domain review for clinical deployment


================================================================================
Running: 10_prepare_crs_dataset.py
Time: 2025-12-14 18:24:56
================================================================================

================================================================================
Preparing CRS Dataset: epcoritamab â†’ CYTOKINE RELEASE SYNDROME
================================================================================

ğŸ“‚ Loading data from main_data.csv...
âœ… Loaded 16728 records

ğŸ”¹ Step 1: Filtering to target drug...
   Found 500 records for epcoritamab

ğŸ”¹ Step 2: Identifying adverse event cases...
   Found 185 records with target adverse event (37.0%)

ğŸ”¹ Step 3: Feature engineering...
ğŸ”¹ Step 4: Generating missingness summary...
âœ… Saved: crs_dataset_prepared_missingness_summary.csv

ğŸ”¹ Step 5: Saving prepared dataset...
âœ… Saved: crs_dataset_prepared.csv (185 records)

================================================================================
âœ… CRS Dataset Preparation Complete!
================================================================================

Generated files:
  - crs_dataset_prepared.csv
  - crs_dataset_prepared_missingness_summary.csv


================================================================================
Running: 11_granular_crs_analysis.py
Time: 2025-12-14 18:24:56
================================================================================

======================================================================
Granular CRS â†’ Death Analysis: Epcoritamab
======================================================================

ğŸ“‚ Loading data from main_data.csv...
âœ… Loaded 16728 records

======================================================================
Step 1: Identifying CYTOKINE RELEASE SYNDROME Cases
======================================================================
ğŸ“Š Total Epcoritamab records: 500
ğŸ” Patients with CYTOKINE RELEASE SYNDROME: 185 (37.0%)
   Deaths in CYTOKINE RELEASE SYNDROME patients: 150 (81.1% of CYTOKINE RELEASE SYNDROME patients)

======================================================================
Step 2: Granular Feature Engineering
======================================================================

ğŸ“Š Age Stratification...
   Age >65: 270 patients
   Age >70: 179 patients
   Age >75: 85 patients

ğŸ“Š BMI Calculation...
   Patients with BMI data: 418
   Obese (BMI>30): 142 patients (34.0%)

ğŸ“Š Comorbidity Extraction...
   Diabetes: 81 patients (16.2%)
   Hypertension: 97 patients (19.4%)
   Infection: 144 patients (28.8%)
   Cardiac: 23 patients (4.6%)
   Renal: 33 patients (6.6%)
   Liver: 3 patients (0.6%)
   Cancer: 431 patients (86.2%)

ğŸ“Š Drug Category Extraction...
   steroids: 390 patients (78.0%)
   immunosuppressants: 0 patients (0.0%)
   antibiotics: 114 patients (22.8%)
   antifungals: 111 patients (22.2%)
   antivirals: 328 patients (65.6%)
   chemo: 115 patients (23.0%)
   targeted_therapy: 376 patients (75.2%)

ğŸ“Š Specific Drug Combination Analysis...
   Steroid + Antibiotic: 104 patients
   Steroid + Antifungal: 105 patients

ğŸ“Š Infection-Related AE Analysis...
   Infection-related AE: 136 patients (27.2%)

ğŸ“Š Cancer Stage Extraction (from drug_indication field)...
   Patients with stage information: 130 (26.0%)
   Stage I: 6 patients
   Stage II: 24 patients
   Stage III: 94 patients
   Stage IV: 6 patients

âœ… Granular feature engineering complete

======================================================================
Step 3: Stratified Analysis with Specific Cutoffs
======================================================================

ğŸ“Š Analyzing 185 CRS patients...

ğŸ”¹ Age Stratification Analysis:
   Age >65: 96/115 deaths (83.5%)
   Age â‰¤65: 31/46 deaths (67.4%)

ğŸ”¹ BMI/Obesity Analysis:
   Obese (BMI>30): 29/37 deaths (78.4%)
   Non-obese: 121/148 deaths (81.8%)

ğŸ”¹ Comorbidity Analysis:
   Diabetes: 29/37 deaths (78.4%)
   Hypertension: 29/31 deaths (93.5%)
   Infection: 33/39 deaths (84.6%)
   Cardiac: 3/3 deaths (100.0%)
   Liver: 3/3 deaths (100.0%)
   Cancer: 135/166 deaths (81.3%)

ğŸ”¹ Drug Combination Analysis:
   Steroid + Antibiotic: 29/31 deaths (93.5%)

ğŸ”¹ Infection AE + Comorbidity Analysis:
   Infection AE + Diabetes: 19/24 deaths (79.2%)

ğŸ”¹ Cancer Stage Stratification Analysis:
   Stage I-II (Early): 7/8 deaths (87.5%)
   Stage III-IV (Advanced): 23/26 deaths (88.5%)
   Stage II: 7/8 deaths (87.5%)
   Stage III: 23/26 deaths (88.5%)

======================================================================
Step 3.5: Summary Tables (Clear Cutoffs & Numbers)
======================================================================

ğŸ“Š Table 1: Age Stratification - CRS â†’ Death Rates
----------------------------------------------------------------------
                    N_Total  N_Deaths  Death_Rate  Death_Rate_Pct
age_group_detailed                                               
<50                      10         5       0.500            50.0
50-65                    36        26       0.722            72.2
65-75                    79        66       0.835            83.5
>75                      36        30       0.833            83.3

ğŸ“Š Table 2: BMI Stratification - CRS â†’ Death Rates
----------------------------------------------------------------------
           Category  N_Total  N_Deaths  Death_Rate_Pct
   Normal (18.5-25)       48        37            77.1
 Overweight (25-30)       42        36            85.7
        Obese (>30)       37        29            78.4
Underweight (<18.5)       22        18            81.8

ğŸ“Š Table 3: Polypharmacy Comparison - CRS â†’ Death Rates
----------------------------------------------------------------------
                    N_Total  N_Deaths  Death_Rate  Death_Rate_Pct
polypharmacy_group                                               
Low (â‰¤1)                  0         0         NaN             NaN
Moderate (2-5)           12         7       0.583            58.3
High (>5)               170       140       0.824            82.4

ğŸ“Š Table 4: Drug Combination Comparison - CRS â†’ Death Rates
----------------------------------------------------------------------
                Group  N_Total  N_Deaths  Death_Rate_Pct
 Steroid + Antibiotic       31        29            93.5
No Steroid+Antibiotic      154       121            78.6

ğŸ“Š Table 5: Comorbidity Comparison - CRS â†’ Death Rates
----------------------------------------------------------------------
Comorbidity  Status  N_Total  N_Deaths  Death_Rate_Pct
   Diabetes    With       37        29            78.4
   Diabetes Without      148       121            81.8

ğŸ“Š Table 6: Infection AE Comparison - CRS â†’ Death Rates
----------------------------------------------------------------------
               Group  N_Total  N_Deaths  Death_Rate_Pct
   With Infection AE       39        33            84.6
Without Infection AE      146       117            80.1


======================================================================
Step 4: Top Drug Combination Analysis
======================================================================

ğŸ“Š Top 10 Drug Combinations by Death Rate:
   1. CARBOPLATIN + CARBOPLATIN
      Death rate: 100.0% (11/11)
   2. DIPHENHYDRAMINE HYDROCHLORIDE + GEMCITABINE HYDROCHLORIDE
      Death rate: 100.0% (3/3)
   3. METHYLPREDNISOLONE SODIUM SUCC + PREDNISONE
      Death rate: 100.0% (4/4)
   4. CYCLOPHOSPHAMIDE FOR INJECTION + DOXORUBICIN HYDROCHLORIDE
      Death rate: 100.0% (4/4)
   5. METHYLPREDNISOLONE SODIUM SUCC + METHYLPREDNISOLONE SODIUM SUCC
      Death rate: 100.0% (11/11)
   6. ACYCLOVIR + OMEPRAZOLE MAGNESIUM
      Death rate: 100.0% (4/4)
   7. OMEPRAZOLE + OMEPRAZOLE
      Death rate: 100.0% (7/7)
   8. METHYLPREDNISOLONE SODIUM SUCC + RITUXIMAB
      Death rate: 100.0% (3/3)
   9. CYCLOPHOSPHAMIDE INJECTION, SO + RITUXIMAB
      Death rate: 100.0% (11/11)
   10. CANNABIDIOL + GEMCITABINE HYDROCHLORIDE
      Death rate: 100.0% (5/5)

======================================================================
ğŸ“Š Drug Usage Summary: CRS-Death vs CRS-Survival
======================================================================

       Drug Category CRS-Death % CRS-Survival %     Difference
            Steroids       82.7%          65.7%         +17.0%
          Antibiotic       20.7%           8.6%         +12.1%
           Antiviral       68.0%          42.9%         +25.1%
          Antifungal       16.7%           5.7%         +11.0%
Steroid + Antibiotic       93.5%            N/A 29/31 patients

âœ… Saved: crs_drug_usage_summary.csv


======================================================================
Step 5: Generating Granular Report
======================================================================
âœ… Saved report: ./granular_crs_report.md

======================================================================
Step 6: Generating Visualizations
======================================================================
âœ… Saved: crs_age_stratification.png
âœ… Saved: crs_bmi_stratification.png
âœ… Saved: crs_comorbidity_comparison.png

âœ… Visualization complete

======================================================================
Step 6.5: Missingness Summary
======================================================================

âœ… Saved: ./crs_missingness_summary.csv

ğŸ“Š Key Missingness Statistics:
----------------------------------------------------------------------
   age_years: 87.0% complete, 13.0% missing
   patientweight: 80.5% complete, 19.5% missing
   bmi: 80.5% complete, 19.5% missing
   num_drugs: 100.0% complete, 0.0% missing
   num_reactions: 100.0% complete, 0.0% missing


======================================================================
Step 7: Plain Language Summary (Ready for Slides/Reports)
======================================================================

======================================================================
PLAIN LANGUAGE SUMMARY FOR PRESENTATION
======================================================================

ğŸ”‘ Key Drug Usage Findings:

   â€¢ For CRS patients on epcoritamab, steroid use is much more common in fatal cases than in survivors (83% vs 66%).
   â€¢ The combination of steroids and antibiotics is associated with a very high observed death rate in CRS cases (93.5 percent, 29 of 31 patients).

----------------------------------------------------------------------

ğŸ“Š Age Stratification Findings:

   â€¢ Age <50 CRS patients: 50.0% death rate (5/10 patients)
   â€¢ Age 50-65 CRS patients: 72.2% death rate (26/36 patients)
   â€¢ Age 65-75 CRS patients: 83.5% death rate (66/79 patients)
   â€¢ Age >75 CRS patients: 83.3% death rate (30/36 patients)

   â†’ Patients over 75 years have 1.7x higher death risk than patients under 50 years (83.3% vs 50.0%)

ğŸ“Š BMI Stratification Findings:

   â€¢ Normal (18.5-25) CRS patients: 77.1% death rate (37/48 patients)
   â€¢ Overweight (25-30) CRS patients: 85.7% death rate (36/42 patients)
   â€¢ Obese (>30) CRS patients: 78.4% death rate (29/37 patients)
   â€¢ Underweight (<18.5) CRS patients: 81.8% death rate (18/22 patients)

   â†’ Obese patients: 78.4% death rate; Underweight patients: 81.8% death rate

ğŸ“Š Polypharmacy Findings:

   â€¢ High polypharmacy (>5 drugs): 82.4% death rate (140/170 patients)
   â€¢ Low polypharmacy (â‰¤1 drug): nan% death rate (0/0 patients)

   â†’ High polypharmacy patients have 0.0x higher death risk than low polypharmacy patients

ğŸ“Š Drug Combination Findings:

   â€¢ CRS patients on Steroid + Antibiotic: 93.5% death rate (29/31 patients)
   â€¢ CRS patients without this combination: 78.6% death rate (121/154 patients)

   â†’ Steroid + Antibiotic combination is associated with 1.2x higher death risk compared to patients without this combination

ğŸ“Š Comorbidity Findings:

   â€¢ CRS patients with Diabetes: 78.4% death rate (29/37 patients)
   â€¢ CRS patients without Diabetes: 81.8% death rate (121/148 patients)

   â†’ Diabetes is associated with 1.0x higher death risk in CRS patients

ğŸ“Š Infection AE Findings:

   â€¢ CRS patients with infection-related AE: 84.6% death rate (33/39 patients)
   â€¢ CRS patients without infection AE: 80.1% death rate (117/146 patients)

   â†’ Infection-related adverse events are associated with 1.1x higher death risk in CRS patients

======================================================================
KEY COMBINED RISK FACTORS
======================================================================

   â€¢ CRS patients aged >75 years with high polypharmacy (>5 drugs) have approximately 1.0x higher death risk compared to the overall CRS population (81.1%)


âœ… Saved plain language summary: crs_plain_language_summary.txt
   â†’ This file can be directly copied to slides and reports!

======================================================================
âœ… Granular CRS Analysis Complete!
======================================================================

Generated files:
  - ./granular_crs_report.md
  - ./crs_plain_language_summary.txt â­ (Ready for slides!)
  - ./crs_age_stratification.png
  - ./crs_bmi_stratification.png (if BMI data available)
  - ./crs_comorbidity_comparison.png
  - ./granular_crs_meta.json


================================================================================
Running: 12_crs_model_training.py
Time: 2025-12-14 18:24:58
================================================================================

================================================================================
CRS-Specific Model Training: CRS â†’ Death Prediction
================================================================================

ğŸ“‚ Loading data from main_data.csv...
âœ… Loaded 16728 records

================================================================================
Step 1: Identifying Epcoritamab Patients with Adverse Event
================================================================================
ğŸ“Š Total Epcoritamab records: 500
ğŸ” Patients with CYTOKINE RELEASE SYNDROME: 185 (37.0%)
ğŸ“Š Deaths in CYTOKINE RELEASE SYNDROME patients: 150 (81.1%)

================================================================================
Step 2: Building Features for CRS â†’ Death Prediction
================================================================================

ğŸ”¹ Age Features...
ğŸ”¹ Sex Features...
ğŸ”¹ Weight/BMI Features...
ğŸ”¹ Drug-Related Features...
ğŸ”¹ Reaction Count Features...
ğŸ”¹ Drug Category Features...
ğŸ”¹ Comorbidity Features...
ğŸ”¹ Cancer Stage Features...
   Stage I: 0 patients
   Stage II: 8 patients
   Stage III: 26 patients
   Stage IV: 0 patients
ğŸ”¹ Infection-Related AE Features...

âœ… Built 34 features
   Features: age_years, age_missing, age_gt_65, age_gt_70, age_50_65, sex_male, sex_female, sex_unknown, patientweight, weight_missing, bmi, bmi_obese, bmi_overweight, bmi_underweight, num_drugs...

================================================================================
Step 3: Training Models on CRS Data
================================================================================

ğŸ“Š Dataset: 185 CRS patients, 150 deaths (81.1% positive)
   Train: 103, Validation: 26, Test: 56

ğŸ”¹ Training Logistic Regression...
ğŸ”¹ Training Random Forest...
ğŸ”¹ Training Gradient Boosting...
ğŸ”¹ Training XGBoost...

================================================================================
ğŸ“Š Model Performance Summary
================================================================================

ğŸ“ˆ Class Distribution (Test Set):
   Positive (Death): 45/56 (80.4%)
   Negative (Survival): 11/56 (19.6%)
   Imbalance Ratio: 0.24:1

--------------------------------------------------------------------------------

Logistic Regression:
   ROC-AUC:     0.6061
   PR-AUC:      0.8645
   Precision:   0.8205
   Recall:      0.7111
   F1-Score:    0.7619
   Accuracy:    0.6429

Random Forest:
   ROC-AUC:     0.6242
   PR-AUC:      0.8956
   Precision:   0.8049
   Recall:      0.7333
   F1-Score:    0.7674
   Accuracy:    0.6429

Gradient Boosting:
   ROC-AUC:     0.6020
   PR-AUC:      0.8824
   Precision:   0.7885
   Recall:      0.9111
   F1-Score:    0.8454
   Accuracy:    0.7321

XGBoost:
   ROC-AUC:     0.5091
   PR-AUC:      0.8309
   Precision:   0.7708
   Recall:      0.8222
   F1-Score:    0.7957
   Accuracy:    0.6607

================================================================================
âœ… Best Model (by PR-AUC): Random Forest
================================================================================
   ROC-AUC:     0.6242
   PR-AUC:      0.8956
   Precision:   0.8049
   Recall:      0.7333
   F1-Score:    0.7674
   Accuracy:    0.6429

--------------------------------------------------------------------------------
ğŸ“Š Clinical Utility Assessment:
--------------------------------------------------------------------------------
   At ~70% recall threshold (0.778):
   - Precision: 100.0%
   - Recall:    66.7%

================================================================================
ğŸ’¡ Model Interpretation Summary:
================================================================================
   Although positive cases represent only 80.4% of CRS patients, 
   the model achieves 100.0% precision at 66.7% recall, 
   indicating potential utility as a screening tool for identifying high-risk CRS patients.
   The PR-AUC of 0.896 demonstrates strong performance on this 
   imbalanced classification task (0.2:1 imbalance ratio).
================================================================================

================================================================================
Step 4: Analyzing Feature Importance
================================================================================

ğŸ“Š Feature Importance Analysis (Best Model: Random Forest)

ğŸ“‹ Complete Feature Importance List (34 features):
--------------------------------------------------------------------------------
  1. num_drugs                                : 0.212604
  2. has_chemo                                : 0.111008
  3. age_years                                : 0.100930
  4. num_reactions                            : 0.094323
  5. bmi                                      : 0.051704
  6. patientweight                            : 0.048338
  7. cancer_stage_III                         : 0.033980
  8. has_targeted                             : 0.032123
  9. sex_female                               : 0.031807
 10. age_gt_70                                : 0.029524
 11. multiple_reactions                       : 0.026535
 12. has_steroid                              : 0.025506
 13. has_antiviral                            : 0.025222
 14. age_gt_65                                : 0.022909
 15. sex_male                                 : 0.018169
 16. has_infection_ae                         : 0.017382
 17. high_polypharmacy                        : 0.016648
 18. age_missing                              : 0.016328
 19. steroid_plus_antibiotic                  : 0.014318
 20. bmi_overweight                           : 0.012874
 21. has_antibiotic                           : 0.012222
 22. age_50_65                                : 0.011514
 23. bmi_obese                                : 0.009652
 24. bmi_underweight                          : 0.009051
 25. has_antifungal                           : 0.007870
 26. weight_missing                           : 0.004628
 27. cancer_stage_II                          : 0.002828
 28. sex_unknown                              : 0.000000
 29. polypharmacy                             : 0.000000
 30. comorbidity_diabetes                     : 0.000000
 31. comorbidity_hypertension                 : 0.000000
 32. comorbidity_cardiac                      : 0.000000
 33. cancer_stage_I                           : 0.000000
 34. cancer_stage_IV                          : 0.000000

ğŸ” Top 15 Most Important Features for CRS â†’ Death Prediction:
--------------------------------------------------------------------------------
 1. num_drugs                      : 0.2126
 2. has_chemo                      : 0.1110
 3. age_years                      : 0.1009
 4. num_reactions                  : 0.0943
 5. bmi                            : 0.0517
 6. patientweight                  : 0.0483
 7. cancer_stage_III               : 0.0340
 8. has_targeted                   : 0.0321
 9. sex_female                     : 0.0318
10. age_gt_70                      : 0.0295
11. multiple_reactions             : 0.0265
12. has_steroid                    : 0.0255
13. has_antiviral                  : 0.0252
14. age_gt_65                      : 0.0229
15. sex_male                       : 0.0182

âœ… Cancer stage features found: cancer_stage_I, cancer_stage_II, cancer_stage_III, cancer_stage_IV
   cancer_stage_I: importance = 0.000000 (rank: 33)
   cancer_stage_II: importance = 0.002828 (rank: 27)
   cancer_stage_III: importance = 0.033980 (rank: 7)
   cancer_stage_IV: importance = 0.000000 (rank: 34)

================================================================================
Step 5: Generating Clinical Report
================================================================================
âœ… Saved report: crs_model_clinical_report.md

âœ… Saved best model: crs_model_best.pkl (includes test data for SHAP analysis)

================================================================================
ğŸ” Saving SHAP Values for Interpretability
================================================================================
âš ï¸  SHAP value generation failed: Must pass 2-d input. shape=(56, 34, 2)
   Continuing without SHAP values...

================================================================================
ğŸ“‹ Exporting Feature Inventory Table
================================================================================

ğŸ“‹ Creating Feature Inventory Table...
âœ… Saved: crs_feature_inventory.csv (34 features)

ğŸ“Š Feature Inventory Summary by Category:
--------------------------------------------------------------------------------
  Adverse Event: 3 variables
  Cancer Stage: 4 variables
  Comorbidity: 3 variables
  Data Quality: 2 variables
  Demographic: 10 variables
  Medication: 10 variables
  Other: 2 variables

================================================================================
ğŸ“‹ Exporting Feature Inventory Table
================================================================================

ğŸ“‹ Creating Feature Inventory Table...
âœ… Saved: crs_feature_inventory.csv (34 features)

ğŸ“Š Feature Inventory Summary by Category:
--------------------------------------------------------------------------------
  Adverse Event: 3 variables
  Cancer Stage: 4 variables
  Comorbidity: 3 variables
  Data Quality: 2 variables
  Demographic: 10 variables
  Medication: 10 variables
  Other: 2 variables

================================================================================
âœ… CRS Model Training Complete!
================================================================================

Generated files:
  - crs_model_best.pkl (trained model)
  - crs_model_feature_importance.png
  - crs_feature_importance.csv
  - crs_model_clinical_report.md
  - crs_model_meta.json
  - crs_feature_inventory.csv (variable list + data sources)
  - crs_feature_inventory.csv (variable list + data sources)


================================================================================
Running: 13_crs_shap_analysis.py
Time: 2025-12-14 18:24:59
================================================================================

================================================================================
CRS-Specific SHAP Analysis with Plain Language Explanations
================================================================================

âœ… Loaded test data: 56 samples

================================================================================
Generating SHAP Explanations for CRS â†’ Death Model
================================================================================

ğŸ“Š Analyzing 56 CRS patients...

ğŸ”¹ Initializing SHAP explainer...
âš ï¸  TreeExplainer failed, trying KernelExplainer: isinstance() arg 2 must be a type or tuple of types

  0%|          | 0/56 [00:00<?, ?it/s]
  2%|â–         | 1/56 [00:00<00:09,  6.11it/s]
  4%|â–         | 2/56 [00:00<00:08,  6.27it/s]
  5%|â–Œ         | 3/56 [00:00<00:08,  6.07it/s]
  7%|â–‹         | 4/56 [00:00<00:09,  5.78it/s]
  9%|â–‰         | 5/56 [00:00<00:08,  5.77it/s]
 11%|â–ˆ         | 6/56 [00:01<00:08,  5.85it/s]
 12%|â–ˆâ–        | 7/56 [00:01<00:08,  5.87it/s]
 14%|â–ˆâ–        | 8/56 [00:01<00:08,  5.96it/s]
 16%|â–ˆâ–Œ        | 9/56 [00:01<00:07,  5.93it/s]
 18%|â–ˆâ–Š        | 10/56 [00:01<00:07,  5.90it/s]
 20%|â–ˆâ–‰        | 11/56 [00:01<00:07,  5.96it/s]
 21%|â–ˆâ–ˆâ–       | 12/56 [00:02<00:07,  5.96it/s]
 23%|â–ˆâ–ˆâ–       | 13/56 [00:02<00:07,  5.95it/s]
 25%|â–ˆâ–ˆâ–Œ       | 14/56 [00:02<00:07,  5.92it/s]
 27%|â–ˆâ–ˆâ–‹       | 15/56 [00:02<00:06,  5.99it/s]
 29%|â–ˆâ–ˆâ–Š       | 16/56 [00:02<00:06,  6.02it/s]
 30%|â–ˆâ–ˆâ–ˆ       | 17/56 [00:02<00:06,  6.00it/s]
 32%|â–ˆâ–ˆâ–ˆâ–      | 18/56 [00:03<00:06,  6.06it/s]
 34%|â–ˆâ–ˆâ–ˆâ–      | 19/56 [00:03<00:06,  6.08it/s]
 36%|â–ˆâ–ˆâ–ˆâ–Œ      | 20/56 [00:03<00:05,  6.06it/s]
 38%|â–ˆâ–ˆâ–ˆâ–Š      | 21/56 [00:03<00:05,  6.06it/s]
 39%|â–ˆâ–ˆâ–ˆâ–‰      | 22/56 [00:03<00:05,  6.02it/s]
 41%|â–ˆâ–ˆâ–ˆâ–ˆ      | 23/56 [00:03<00:05,  6.05it/s]
 43%|â–ˆâ–ˆâ–ˆâ–ˆâ–     | 24/56 [00:03<00:05,  6.16it/s]
 45%|â–ˆâ–ˆâ–ˆâ–ˆâ–     | 25/56 [00:04<00:04,  6.21it/s]
 46%|â–ˆâ–ˆâ–ˆâ–ˆâ–‹     | 26/56 [00:04<00:04,  6.21it/s]
 48%|â–ˆâ–ˆâ–ˆâ–ˆâ–Š     | 27/56 [00:04<00:04,  6.12it/s]
 50%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     | 28/56 [00:04<00:04,  6.10it/s]
 52%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–    | 29/56 [00:04<00:04,  6.17it/s]
 54%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–    | 30/56 [00:04<00:04,  6.19it/s]
 55%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ    | 31/56 [00:05<00:04,  6.19it/s]
 57%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹    | 32/56 [00:05<00:03,  6.20it/s]
 59%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‰    | 33/56 [00:05<00:03,  6.23it/s]
 61%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    | 34/56 [00:05<00:03,  6.21it/s]
 62%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–   | 35/56 [00:05<00:03,  6.16it/s]
 64%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–   | 36/56 [00:05<00:03,  6.17it/s]
 66%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ   | 37/56 [00:06<00:03,  6.10it/s]
 68%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š   | 38/56 [00:06<00:02,  6.13it/s]
 70%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‰   | 39/56 [00:06<00:02,  6.08it/s]
 71%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–  | 40/56 [00:06<00:02,  6.10it/s]
 73%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–  | 41/56 [00:06<00:02,  6.06it/s]
 75%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ  | 42/56 [00:06<00:02,  6.08it/s]
 77%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹  | 43/56 [00:07<00:02,  6.08it/s]
 79%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š  | 44/56 [00:07<00:01,  6.12it/s]
 80%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  | 45/56 [00:07<00:01,  6.14it/s]
 82%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ– | 46/56 [00:07<00:01,  6.17it/s]
 84%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ– | 47/56 [00:07<00:01,  6.11it/s]
 86%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ | 48/56 [00:07<00:01,  6.14it/s]
 88%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š | 49/56 [00:08<00:01,  6.19it/s]
 89%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‰ | 50/56 [00:08<00:00,  6.12it/s]
 91%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ | 51/56 [00:08<00:00,  6.07it/s]
 93%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–| 52/56 [00:08<00:00,  6.12it/s]
 95%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–| 53/56 [00:08<00:00,  6.12it/s]
 96%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹| 54/56 [00:08<00:00,  6.16it/s]
 98%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š| 55/56 [00:09<00:00,  6.08it/s]
100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 56/56 [00:09<00:00,  6.10it/s]
100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 56/56 [00:09<00:00,  6.08it/s]

ğŸ“Š Generating SHAP visualizations...
âœ… Saved: crs_shap_summary.png
âœ… Saved: crs_shap_bar.png
âœ… Saved: crs_shap_waterfall_death.png
âœ… Saved: crs_shap_waterfall_survival.png
âœ… Saved: crs_shap_values.csv

================================================================================
Global SHAP Interpretation
================================================================================

ğŸ“Š Top 10 Features That INCREASE Death Risk (Positive SHAP):
--------------------------------------------------------------------------------
 1. Cancer Stage III                                   : +0.0044
 2. Age Missing in Report                              : +0.0039
 3. Steroid + Antibiotic Combination                   : +0.0036
 4. Number of Adverse Reactions                        : +0.0025
 5. Infection-Related Adverse Event                    : +0.0021
 6. Receiving Antifungal Medication                    : +0.0015
 7. Overweight (BMI 25-30)                             : +0.0009
 8. Number of Concurrent Medications                   : +0.0008
 9. Receiving Targeted Therapy                         : +0.0007
10. Receiving Antibiotics                              : +0.0003

ğŸ“Š Top 10 Features That DECREASE Death Risk (Negative SHAP):
--------------------------------------------------------------------------------
 1. Female Gender                                      : -0.0041
 2. Patient Age                                        : -0.0030
 3. Receiving Steroids                                 : -0.0029
 4. Patient Weight                                     : -0.0024
 5. Body Mass Index (BMI)                              : -0.0023
 6. Age Over 65 Years                                  : -0.0023
 7. Underweight (BMI <18.5)                            : -0.0018
 8. Multiple Adverse Reactions                         : -0.0018
 9. Receiving Chemotherapy                             : -0.0016
10. High Polypharmacy (>5 drugs)                       : -0.0011

================================================================================
Global Summary (Plain Language)
================================================================================

ğŸ”¹ Key Factors That INCREASE Death Risk:
   â€¢ Cancer Stage III: Strong positive contribution to death risk
   â€¢ Age Missing in Report: Strong positive contribution to death risk
   â€¢ Steroid + Antibiotic Combination: Strong positive contribution to death risk
   â€¢ Number of Adverse Reactions: Strong positive contribution to death risk
   â€¢ Infection-Related Adverse Event: Strong positive contribution to death risk

ğŸ”¹ Key Factors That DECREASE Death Risk:
   â€¢ Female Gender: Protective effect against death risk
   â€¢ Patient Age: Protective effect against death risk
   â€¢ Receiving Steroids: Protective effect against death risk
   â€¢ Patient Weight: Protective effect against death risk
   â€¢ Body Mass Index (BMI): Protective effect against death risk

================================================================================English Summary (Ready for Report)================================================================================
For CRS cases, the model finds that age over 70, and infection-related adverse events are the strongest contributors to death risk.
Steroid plus antibiotic combinations appear frequently among high-risk CRS cases, which may suggest complex clinical situations that warrant closer monitoring.
Advanced age (particularly over 70 years) is consistently associated with increased death risk in CRS patients.


================================================================================
Local SHAP Interpretation (Individual Cases)
================================================================================

--------------------------------------------------------------------------------
ğŸ”¹ High-Risk Case Example (Death Outcome):

   Patient Profile:
   â€¢ A patient with age 1 years and high polypharmacy

   Why the model predicts high death risk:
   â€¢ Number of Concurrent Medications: increases death risk (contribution: +0.085)
   â€¢ Receiving Chemotherapy: increases death risk (contribution: +0.047)
   â€¢ Number of Adverse Reactions: increases death risk (contribution: +0.039)
   â€¢ Receiving Targeted Therapy: increases death risk (contribution: +0.018)
   â€¢ Patient Age: increases death risk (contribution: +0.016)


--------------------------------------------------------------------------------
ğŸ”¹ Low-Risk Case Example (Survival Outcome):

   Why the model predicts lower death risk:
   â€¢ Receiving Chemotherapy: decreases death risk (contribution: -0.080)
   â€¢ Number of Concurrent Medications: decreases death risk (contribution: -0.074)
   â€¢ Patient Weight: decreases death risk (contribution: -0.044)
   â€¢ Body Mass Index (BMI): decreases death risk (contribution: -0.037)
   â€¢ Underweight (BMI <18.5): decreases death risk (contribution: -0.021)


================================================================================
Generating Plain Language Summary
================================================================================
âœ… Saved: crs_plain_language_summary.md

================================================================================
âœ… Analysis Complete!
================================================================================

Generated files:
  - crs_plain_language_summary.md
  - crs_shap_summary.png
  - crs_shap_bar.png
  - crs_shap_waterfall_death.png
  - crs_shap_waterfall_survival.png
  - crs_shap_values.csv


================================================================================
Execution Summary
================================================================================

Started: 2025-12-14 18:19:18
Ended: 2025-12-14 18:25:11
Elapsed time: 0:05:53.151852

Total scripts: 13
Successful: 13
Failed: 0


================================================================================
